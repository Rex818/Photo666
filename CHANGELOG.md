# Photo666 更新日志

## [0.3.0] - 2025-08-16

### 🆕 新增功能
- **JoyCaption插件诊断信息窗口**: 完善的插件状态诊断和问题排查功能
  - 显示插件状态、组件状态、配置状态、模型状态、系统信息
  - 提供使用建议，帮助用户排查JC快速处理功能的问题
  - 支持实时刷新诊断信息，无需重新打开窗口
- **统一的标签管理系统**: 实现 `unified_tags` JSON字段，解决11个冗余标签字段问题
  - 智能双写策略确保向后兼容
  - 支持Florence2等插件正常工作
  - 支持长文本标签（每字段最大2048字节）

### 🔧 技术改进
- **数据库批量操作优化**: 大目录导入速度提升3-5倍
  - 实现 `find_existing_hashes` 批量查询方法
  - 实现 `batch_insert_photos` 批量插入方法
  - 实现 `batch_add_photos_to_album` 批量关联方法
- **相册显示性能优化**: 异步缩略图加载，初始加载速度提升5-8倍
  - 实现异步缩略图加载 (QThreadPool + QRunnable)
  - 实现虚拟化显示 (分页 + 按需加载)
  - 实现无限滚动加载
- **滚动性能优化**: 滚动事件节流、缩略图缓存、可见性检测
  - 滚动事件节流 (100ms节流)
  - 缩略图项缓存机制 (最大20个缓存项)
  - 智能虚拟化管理 (最大150个可见项)
- **搜索功能增强**: 支持单词、词组、句子、引号精确匹配
  - 统一标签系统集成，搜索更准确
  - 支持逗号、分号分隔多个关键词
  - 支持引号包围的精确词组匹配

### 🐛 问题修复
- **修复JoyCaption插件诊断信息窗口问题**
  - 修复刷新按钮每次点击都创建新窗口的问题
  - 修复关闭按钮报错的问题
  - 重构代码，提取格式化方法，避免代码重复
- **修复数据库字段不一致问题**
  - 解决11个冗余标签字段导致的数据混乱和性能问题
  - 实现58张照片的数据库迁移，0个错误
  - 确保所有插件兼容性
- **修复AI信息显示和标签翻译保存问题**
  - 修复照片切换时AI信息不更新问题
  - 修复AI元数据JSON字符串解析问题
  - 修复翻译功能删除原有标签的问题

### 📋 兼容性
- **完全兼容原有的所有插件和功能**
  - 保持现有数据库结构，通过兼容性层支持旧版本
  - 支持Florence2、JoyCaption等所有现有插件
  - 向后兼容所有现有功能

### 🔄 内部开发版本
- 内部开发版本: v1.5.4 (性能优化与用户体验提升版) ✅ 当前版本
- 包含完整的性能优化和用户体验改进
- 包含JoyCaption插件诊断信息窗口修复
- 包含数据库批量操作和相册显示性能优化

## [0.2.0] - 2025-08-03

### 🆕 新增功能
- **Midjourney图片信息识别**: 新增对Midjourney生成图片的AI元数据识别和显示功能
  - 支持从PNG文件的Description字段提取Midjourney参数
  - 自动识别Job ID、版本、风格化等参数
  - 在"AI图片信息"区域显示完整的Midjourney参数
- **AI元数据字段扩展**: 新增Midjourney专用参数显示区域
  - 任务ID (Job ID)
  - 版本 (Version) 
  - 风格化 (Stylize)
  - 质量 (Quality)
  - 宽高比 (Aspect Ratio)
  - 原始模式 (Raw Mode)
  - 混乱度 (Chaos)
  - 平铺模式 (Tile)
  - Niji模式 (Niji)
  - 怪异度 (Weird)

### 🔧 技术改进
- **数据库检索优化**: 修复AI元数据从数据库检索时的JSON解析问题
  - 改进`DatabaseManager.get_photo`方法的JSON字段解析逻辑
  - 添加安全的JSON解析异常处理
  - 支持处理空值和无效JSON数据
- **错误处理增强**: 改进AI元数据解析的异常处理机制
  - 添加详细的错误日志记录
  - 实现优雅的错误恢复机制
- **调试信息完善**: 添加详细的AI元数据检索调试日志
  - 在`PhotoManager.get_photo_ai_metadata`中添加调试输出
  - 便于问题诊断和性能监控

### 🐛 问题修复
- **修复ComfyUI图片AI元数据无法正确读取的问题**
  - 解决了数据库检索时JSON解析异常
  - 确保所有AI图片类型的元数据都能正确显示
- **修复数据库JSON字段解析异常导致的程序崩溃**
  - 添加了安全的JSON解析机制
  - 防止因无效JSON数据导致的程序错误
- **修复AI元数据为空时的处理逻辑**
  - 正确处理空值和None值
  - 确保程序稳定运行

### 📋 兼容性
- **完全兼容原有的WEBUI和ComfyUI图片信息识别功能**
  - 保持现有功能不变
  - 不影响已导入的图片数据
- **保持现有数据库结构不变**
  - 无需数据库迁移
  - 向后兼容所有现有数据
- **向后兼容所有现有功能**
  - 标签管理系统
  - 相册管理功能
  - 图片导入导出功能

### 🔄 内部开发版本
- 内部开发版本: v1.5.2 (性能优化与用户体验提升版)
- 包含多线程批量导入系统架构设计
- 包含PhotoManager优化方法
- 包含数据库批量操作优化

## [0.1.0] - 2025-07-XX

### 🎉 初始版本
- **基础图片管理功能**
  - 图片导入和分类
  - 缩略图生成
  - 文件去重
- **AI图片信息识别**
  - Stable Diffusion WebUI图片信息识别
  - ComfyUI图片信息识别
  - AI元数据显示
- **标签管理系统**
  - 多级标签分类
  - 标签翻译功能
  - 标签导入导出
- **相册管理功能**
  - 相册创建和管理
  - 图片分组
  - 相册封面设置
- **插件系统**
  - 模块化插件架构
  - 插件热加载
  - 配置管理

### 🔧 技术特性
- **PyQt6 GUI框架**: 现代化用户界面
- **SQLite数据库**: 轻量级数据存储
- **多线程处理**: 提高程序响应速度
- **AI模型集成**: 支持多种AI功能
- **国际化支持**: 多语言界面

---

## 版本命名规则
- **发布版本**: v0.x.x (面向用户)
- **内部开发版本**: v1.x.x (开发阶段)
- **功能版本**: 主版本号.次版本号.修订号

## 更新频率
- **发布版本**: 功能稳定后发布
- **内部版本**: 开发过程中持续更新
- **紧急修复**: 发现严重问题时立即发布
